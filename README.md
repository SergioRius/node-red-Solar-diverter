# node-red-solar-diverter [![Donate](https://img.shields.io/badge/Donate-PayPal-green.svg)](https://www.paypal.com/donate?business=JRX9JK6SSY25N&no_recurring=0&item_name=Open+source+donations&currency_code=EUR)
## _A node-red based solar diverter_

This is a combination of node-red flow and a minimal set of hardware that allows to divert solar generated energy to non electronic controlled devices, like a water heater or small heat accumulators.

## Features

- Minimal and cheap hardware parts required.
  With just a chinese AC Dimmer and an ESP8266 you can work out the project.
- All the involved functions and requirements integrated in just one flow.
- Can manage excess energy from both feed-in or zero-feed systems.
- Uses a PID controller for a smooth operation.
- Publishes a small dashboard for easily testing and adjust.

## Hardware

You will need an AC Dimmer rated for the required duty. I've been using the one (16A) on the [following link](https://es.aliexpress.com/item/1005001965951718.html?spm=a2g0s.9042311.0.0.3cb763c0xwzS4K) with success with a 1500W water heater. Always when buying from chinese sources, chose a higher rating one. You should add an small fan to the heat-sink.

Then connect an ESP8266 to the dimmer and provide a suitable power source. You can power the board using a PSU or a phone charger.

The code for the ESP is contained at the root of the github repo. For the moment does not have any captive portal or other extra functionalities other than the minimal needed. Just edit the main file for entering your wifi SSID and Key and burn to the ESP using platformio.

The sketch will setup the ESP+Dimmer to receive the PWM setpoint via mqtt at the topic 'PWMController/value' and establish a time wachdog to avoid diverting if messages are not received for a period of time.

## Flow

![The flow](https://github.com/SergioRius/node-red-Solar-diverter/blob/main/flows/flow.png?raw=true)

The flow has three parts: The upper-center one has the programming logic for the divert manager. You should edit the mqtt output node at the right and edit to match the topic configured in your ESP. On the center section a PID algorithm is implemented along with a manual override.

On the lower-left region is the inputs section. You only need to feed the `in_Watts` input with the power source to monitor. Being grid feed-in, or battery watts in case of self-consumption.
There are implemented two possible ways of automating the diverter. The upper one uses the battery state (bulk/absorption/float) to dinamically set the diverting setpoint, but you could replace it with a SoC percentage logic. If you set a very high setpoint, will behave the same as it was turn off.
The last one turns on or off the system based on SoC. Could also be the daylight detection reported by some mppt controllers. This is useful in a zero-feedin system, as it could also have a nightly charging cycle, to avoid diverting in that cases.

The right section has the default values node, `node-red-contrib-set-defaults` node is required here, and publishes an small dashboard useful for adjusting the PID coefficients, supervising and manually overriding the functions of the flow. Just like in the image below:

![Control panel](https://github.com/SergioRius/node-red-Solar-diverter/blob/main/flows/dashboard.png?raw=true)

You can setup several PID implementations with their own parameters and switch them here and compare the results, as well as turning all off.

```json
[{"id":"69b7af92a5a069e7","type":"tab","label":"Diverter","disabled":false,"info":""},{"id":"1ebb39946d4a0248","type":"group","z":"69b7af92a5a069e7","style":{"stroke":"#2e333a","stroke-opacity":"1","fill":"#383c45","fill-opacity":"0.5","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["4ee087840444d137","7eac57b524a03f37","4981a0352dc12140","efc6da24267cdd5c","895aa4ccdc0a6bed","e4c14ec79b7c7a46","2fafda72492ac785","e9c09d2649be3698","6bd46ca443c5b1f4","54e9dc534364fced","2d735d228482c173","ba2b6e7a8a89faad","fd15a80c9bac014a","40b4008d03db2b5b","e83125d57897d05b","67fbaa31380a19c8","785f6cfe025b6f42","11a95de179a81c82","be6d293e1e155cb3","3c01972bbf2db5c7","78acef3bcd0e7b23","d81def18fcf2bf5c","8f667782db66fa88","4837586ca7ffef26","b333e19864118858","99a6ea2d44904081","ca3ae8ae746f4a99","89f3a67e239a2278"],"x":34,"y":459,"w":722,"h":602},{"id":"894b547d465dbcea","type":"group","z":"69b7af92a5a069e7","style":{"stroke":"#2e333a","stroke-opacity":"1","fill":"#383c45","fill-opacity":"0.5","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["a5911b073928a105","84f0cf4426fc1702","dbcd6e62ba3517eb","3985396671d4b555","b9acc91fc468a4a0","e41425878e7c526c","41365772667d311d","d557fae7edb437b2","019d61289868399d","531283fca50cc81b","d8ab4b4f269e778c","591577a08e11ee67","f30853db762475ab","a603015cab524e4f","3679467fdf3ef7b5"],"x":274,"y":39,"w":1352,"h":322},{"id":"9f2cc92f0cfdb0ad","type":"group","z":"69b7af92a5a069e7","style":{"stroke":"#2e333a","stroke-opacity":"1","fill":"#383c45","fill-opacity":"0.5","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["a5fe6eda6dc18972","a1ab586e5a92a450","7b45bd53eeeff4f2","fe161b56ce962044","8dbfd942274ce65d","e16fa10e0dc9778b","020f2c19ab1ecb6a","346ba9a2c6df61c2","9ba97afd56232b28","52d3434733e7c601","7a169ab189f9bca6","ceca47f1277e1bd8","438a974f87ab21df","e59f8d497d6b2d2d","09bb4f53ed3f2596","398a034941ce8737","72aec506e9ed87dc","e1f256ed03eab460","6687c3e6afc05568","a442f16b2d179353","815ac988055a612a","684dc605d7dfb708","402c01b8a5c93089","93bad4db60cce25c","5d08272e672b2117","79aa841688fb1040","020734ce99e70bfc","08e07ab8bce4d1d4","00b9d66554df4dce","2c4d79b34f1cfa44","3c31bff57312dc9c","3eafd083bf01380c"],"x":774,"y":519,"w":952,"h":502},{"id":"a5fe6eda6dc18972","type":"inject","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","props":[{"p":"topic","vt":"str"},{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"setpoint","payload":"100","payloadType":"num","x":1070,"y":940,"wires":[["684dc605d7dfb708"]]},{"id":"4ee087840444d137","type":"debug","z":"69b7af92a5a069e7","g":"1ebb39946d4a0248","name":"","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":190,"y":600,"wires":[]},{"id":"a1ab586e5a92a450","type":"ui_chart","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","group":"c45a83a3.d00908","order":1,"width":0,"height":0,"label":"","chartType":"line","legend":"true","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":"60","removeOlderPoints":"","removeOlderUnit":"1","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#f7a359","#ff5c5f","#8afdff","#98df8a","#df8bdc","#d62728","#ff9896","#9467bd","#c5b0d5"],"outputs":1,"useDifferentColor":false,"x":1610,"y":600,"wires":[[]]},{"id":"7b45bd53eeeff4f2","type":"inject","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"Clear chart on deploy","repeat":"","crontab":"","once":true,"topic":"","payload":"{\"data\":[]}","payloadType":"json","x":1160,"y":600,"wires":[["fe161b56ce962044"]]},{"id":"fe161b56ce962044","type":"change","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","rules":[{"t":"move","p":"payload.data","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1396,"y":600,"wires":[["a1ab586e5a92a450"]]},{"id":"a5911b073928a105","type":"mqtt out","z":"69b7af92a5a069e7","g":"894b547d465dbcea","name":"","topic":"heater1/value","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"bf885360.b5a32","x":1520,"y":140,"wires":[]},{"id":"8dbfd942274ce65d","type":"ui_slider","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"in","label":"Input","tooltip":"","group":"c45a83a3.d00908","order":5,"width":0,"height":0,"passthru":true,"outs":"end","topic":"topic","topicType":"msg","min":"-500","max":"2000","step":"10","x":1270,"y":720,"wires":[["a442f16b2d179353"]]},{"id":"e16fa10e0dc9778b","type":"inject","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","props":[{"p":"topic","vt":"str"},{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"input","payload":"100","payloadType":"num","x":880,"y":720,"wires":[["8dbfd942274ce65d"]]},{"id":"020f2c19ab1ecb6a","type":"inject","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","props":[{"p":"topic","vt":"str"},{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"input","payload":"300","payloadType":"num","x":1060,"y":760,"wires":[["8dbfd942274ce65d"]]},{"id":"346ba9a2c6df61c2","type":"inject","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","props":[{"p":"topic","vt":"str"},{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"input","payload":"-200","payloadType":"num","x":880,"y":760,"wires":[["8dbfd942274ce65d"]]},{"id":"7eac57b524a03f37","type":"change","z":"69b7af92a5a069e7","g":"1ebb39946d4a0248","name":"in","rules":[{"t":"set","p":"topic","pt":"msg","to":"in","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":560,"wires":[["efc6da24267cdd5c","2fafda72492ac785"]]},{"id":"9ba97afd56232b28","type":"inject","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","props":[{"p":"topic","vt":"str"},{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"setpoint","payload":"1000","payloadType":"num","x":890,"y":940,"wires":[["684dc605d7dfb708"]]},{"id":"52d3434733e7c601","type":"inject","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","props":[{"p":"topic","vt":"str"},{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"setpoint","payload":"2000","payloadType":"num","x":890,"y":900,"wires":[["684dc605d7dfb708"]]},{"id":"84f0cf4426fc1702","type":"switch","z":"69b7af92a5a069e7","g":"894b547d465dbcea","name":"","property":"mode","propertyType":"flow","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"-1","vt":"num"},{"t":"eq","v":"1","vt":"num"}],"checkall":"false","repair":false,"outputs":3,"x":650,"y":220,"wires":[["3985396671d4b555"],["a603015cab524e4f"],["dbcd6e62ba3517eb"]]},{"id":"7a169ab189f9bca6","type":"ui_dropdown","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"mode","label":"Mode","tooltip":"","place":"Select option","group":"c45a83a3.d00908","order":2,"width":0,"height":0,"passthru":true,"multiple":false,"options":[{"label":"Manual","value":-1,"type":"num"},{"label":"OFF","value":0,"type":"num"},{"label":"PID","value":1,"type":"num"}],"payload":"","topic":"topic","topicType":"msg","x":1270,"y":660,"wires":[["ceca47f1277e1bd8"]]},{"id":"ceca47f1277e1bd8","type":"change","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","rules":[{"t":"set","p":"mode","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1440,"y":660,"wires":[[]]},{"id":"dbcd6e62ba3517eb","type":"function","z":"69b7af92a5a069e7","g":"894b547d465dbcea","name":"PID","func":"const SampleTime = 500;\n\nvar setpoint = flow.get(\"setpoint\") || 100;\n\nif (msg.hasOwnProperty(\"setpoint\")) {\n    setpoint = msg.setpoint;\n    node.status({ fill: \"blue\", shape: \"dot\", text: 'sp: ' + setpoint });\n    flow.set(\"setpoint\", setpoint);\n}\n\n// Negative for energy diverting\n// -0.05 / -0.06 / -0.03\n// -0.10 / -0.07 / -0.04\nconst kp = -0.10;\nconst ki = -0.08;\nconst kd = -0.04;\n// const kp = -0.05;\n// const ki = -0.06;\n// const kd = -0.03;\nconst multiplier = 0.4;\n\n// 0 / 1023\nconst outMin = -255;\nconst outMax = 255;\n\nconst pOnE = false; // Proportional on Error  else  Proportional on Measurement\n\nconst now = Date.now();\nconst lastTime = context.get('lastTime') || 0;\nconst timeChange = (now - lastTime);\n\nconst lastInput = context.get('lastInput') || msg.payload;\nvar outputSum = context.get(\"outputSum\") || 0;\n\nif (timeChange < SampleTime) return null;\n\n/*Compute all the working error variables*/\nvar input = msg.payload,\n    error = setpoint - input,\n    dInput = (input - lastInput),\n    output;\n\n/*Compute integral*/\noutputSum += (ki * error);\n\n/*Compute proportional*/\nif (pOnE) { output = kp * error; } /*Add Proportional on Error, if P_ON_E is specified*/\nelse { outputSum -= kp * dInput; output = 0; }  /*Add Proportional on Measurement, if P_ON_M is specified*/\n\nif (outputSum > outMax) outputSum = outMax;\nelse if (outputSum < outMin) outputSum = outMin;\n\n/*Compute derivative*/\noutput -= kd * dInput;\n\n/*Merge*/\noutput += outputSum;\n\nif (output > outMax) output = outMax;\nelse if (output < outMin) output = outMin;\n\noutput *= multiplier;\noutput = Math.round((output + Number.EPSILON) * 1000) / 1000;\n\n/*Remember some variables for next time*/\ncontext.set(\"lastInput\", input);\ncontext.set(\"lastTime\", now);\n\nconst color = input < setpoint ? \"red\" : \"green\";\nnode.status({ fill: color, shape: \"dot\", text: 'sp: ' + setpoint + ', pid: ' + output });\n\nreturn { topic: \"pid\", payload: output };","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":890,"y":300,"wires":[["d557fae7edb437b2"]]},{"id":"438a974f87ab21df","type":"inject","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","props":[{"p":"topic","vt":"str"},{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"setpoint","payload":"20","payloadType":"num","x":1060,"y":980,"wires":[["684dc605d7dfb708"]]},{"id":"e59f8d497d6b2d2d","type":"inject","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"pwm","payload":"0","payloadType":"num","x":870,"y":840,"wires":[["72aec506e9ed87dc"]]},{"id":"09bb4f53ed3f2596","type":"inject","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"pwm","payload":"128","payloadType":"num","x":880,"y":800,"wires":[["72aec506e9ed87dc"]]},{"id":"398a034941ce8737","type":"inject","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"pwm","payload":"255","payloadType":"num","x":1060,"y":840,"wires":[["72aec506e9ed87dc"]]},{"id":"72aec506e9ed87dc","type":"ui_slider","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"pwm","label":"PWM","tooltip":"","group":"c45a83a3.d00908","order":4,"width":0,"height":0,"passthru":true,"outs":"end","topic":"topic","topicType":"msg","min":"0","max":"255","step":1,"x":1270,"y":800,"wires":[["e1f256ed03eab460"]]},{"id":"e1f256ed03eab460","type":"change","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","rules":[{"t":"set","p":"pwm","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1450,"y":800,"wires":[["6687c3e6afc05568"]]},{"id":"6687c3e6afc05568","type":"debug","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":1610,"y":800,"wires":[]},{"id":"3985396671d4b555","type":"change","z":"69b7af92a5a069e7","g":"894b547d465dbcea","name":"PowerOff","rules":[{"t":"set","p":"payload","pt":"msg","to":"0","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":900,"y":200,"wires":[["a5911b073928a105"]]},{"id":"9e41ecfb781aedd9","type":"comment","z":"69b7af92a5a069e7","name":"Solar diverter","info":"","x":110,"y":40,"wires":[]},{"id":"4981a0352dc12140","type":"link in","z":"69b7af92a5a069e7","g":"1ebb39946d4a0248","name":"in_Watts","links":["5c71d5999762987c"],"x":75,"y":560,"wires":[["4ee087840444d137","89f3a67e239a2278"]]},{"id":"b9acc91fc468a4a0","type":"debug","z":"69b7af92a5a069e7","g":"894b547d465dbcea","name":"","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":1510,"y":320,"wires":[]},{"id":"efc6da24267cdd5c","type":"smooth","z":"69b7af92a5a069e7","g":"1ebb39946d4a0248","name":"","property":"payload","action":"mean","count":"7","round":"0","mult":"single","reduce":false,"x":420,"y":560,"wires":[["895aa4ccdc0a6bed"]]},{"id":"895aa4ccdc0a6bed","type":"change","z":"69b7af92a5a069e7","g":"1ebb39946d4a0248","name":"in-smooth","rules":[{"t":"set","p":"topic","pt":"msg","to":"in-smooth","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":560,"y":560,"wires":[["e9c09d2649be3698"]]},{"id":"e41425878e7c526c","type":"inject","z":"69b7af92a5a069e7","g":"894b547d465dbcea","name":"","props":[{"p":"payload"}],"repeat":"0.25","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"in","payloadType":"flow","x":380,"y":200,"wires":[["84f0cf4426fc1702"]]},{"id":"a442f16b2d179353","type":"change","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","rules":[{"t":"set","p":"in","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1460,"y":720,"wires":[[]]},{"id":"815ac988055a612a","type":"inject","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","props":[{"p":"topic","vt":"str"},{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"setpoint","payload":"700","payloadType":"num","x":890,"y":980,"wires":[["684dc605d7dfb708"]]},{"id":"684dc605d7dfb708","type":"ui_slider","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"setpoint","label":"Setpoint","tooltip":"","group":"c45a83a3.d00908","order":3,"width":0,"height":0,"passthru":true,"outs":"end","topic":"topic","topicType":"msg","min":"0","max":"5000","step":"10","x":1280,"y":900,"wires":[["402c01b8a5c93089"]]},{"id":"402c01b8a5c93089","type":"change","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","rules":[{"t":"set","p":"setpoint","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1440,"y":900,"wires":[["93bad4db60cce25c"]]},{"id":"93bad4db60cce25c","type":"debug","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":1610,"y":900,"wires":[]},{"id":"5d08272e672b2117","type":"inject","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payloadType":"str","x":870,"y":660,"wires":[["79aa841688fb1040"]]},{"id":"79aa841688fb1040","type":"set-defaults","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","rules":[{"p":"mode","pt":"flow","to":"1","tot":"num"},{"p":"pwm","pt":"flow","to":"0","tot":"num"},{"p":"setpoint","pt":"flow","to":"6000","tot":"num"}],"chbox_DoOutputToMessage":true,"chbox_SetCurrentToMsg":true,"howSend":{"text":"payload","type":"msg","modifiedValue":"payload"},"dropdown_HowManyMessages":"multiple","dropdownObjOrVal":"value","outputs":3,"x":1030,"y":660,"wires":[["7a169ab189f9bca6"],["72aec506e9ed87dc"],["684dc605d7dfb708"]]},{"id":"41365772667d311d","type":"inject","z":"69b7af92a5a069e7","g":"894b547d465dbcea","name":"","props":[{"p":"pid","v":"pid","vt":"flow"},{"p":"payload"}],"repeat":"0.5","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"pwm","payloadType":"flow","x":390,"y":140,"wires":[["3679467fdf3ef7b5"]]},{"id":"d557fae7edb437b2","type":"change","z":"69b7af92a5a069e7","g":"894b547d465dbcea","name":"","rules":[{"t":"set","p":"pid","pt":"flow","to":"payload","tot":"msg"},{"t":"set","p":"topic","pt":"msg","to":"pid","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1320,"y":280,"wires":[["591577a08e11ee67","b9acc91fc468a4a0"]]},{"id":"019d61289868399d","type":"change","z":"69b7af92a5a069e7","g":"894b547d465dbcea","name":"","rules":[{"t":"set","p":"topic","pt":"msg","to":"pwm","tot":"str"},{"t":"set","p":"payload","pt":"msg","to":"payload + pid","tot":"jsonata"},{"t":"set","p":"payload","pt":"msg","to":"$round(payload)","tot":"jsonata"},{"t":"set","p":"payload","pt":"msg","to":"payload > 255 ? 255 : payload","tot":"jsonata"},{"t":"set","p":"payload","pt":"msg","to":"payload < 0 ? 0 : payload","tot":"jsonata"},{"t":"set","p":"pwm","pt":"flow","to":"payload","tot":"msg"},{"t":"delete","p":"pid","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":890,"y":140,"wires":[["531283fca50cc81b","d8ab4b4f269e778c","a5911b073928a105"]]},{"id":"531283fca50cc81b","type":"debug","z":"69b7af92a5a069e7","g":"894b547d465dbcea","name":"","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":1050,"y":160,"wires":[]},{"id":"020734ce99e70bfc","type":"link in","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"in_pwm","links":["d8ab4b4f269e778c"],"x":995,"y":800,"wires":[["72aec506e9ed87dc"]]},{"id":"d8ab4b4f269e778c","type":"link out","z":"69b7af92a5a069e7","g":"894b547d465dbcea","name":"out_pwm","links":["020734ce99e70bfc","08e07ab8bce4d1d4"],"x":1015,"y":120,"wires":[]},{"id":"08e07ab8bce4d1d4","type":"link in","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","links":["d8ab4b4f269e778c","591577a08e11ee67","2fafda72492ac785","e9c09d2649be3698"],"x":1495,"y":560,"wires":[["a1ab586e5a92a450"]]},{"id":"591577a08e11ee67","type":"link out","z":"69b7af92a5a069e7","g":"894b547d465dbcea","name":"","links":["08e07ab8bce4d1d4"],"x":1475,"y":280,"wires":[]},{"id":"e4c14ec79b7c7a46","type":"comment","z":"69b7af92a5a069e7","g":"1ebb39946d4a0248","name":"Input: Feed with grid W or battery W","info":"","x":200,"y":500,"wires":[]},{"id":"f30853db762475ab","type":"comment","z":"69b7af92a5a069e7","g":"894b547d465dbcea","name":"Output PWM: to send to the device","info":"","x":1460,"y":80,"wires":[]},{"id":"2fafda72492ac785","type":"link out","z":"69b7af92a5a069e7","g":"1ebb39946d4a0248","name":"","links":["08e07ab8bce4d1d4"],"x":375,"y":600,"wires":[]},{"id":"00b9d66554df4dce","type":"link in","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","links":["e9c09d2649be3698"],"x":995,"y":720,"wires":[["8dbfd942274ce65d"]]},{"id":"e9c09d2649be3698","type":"link out","z":"69b7af92a5a069e7","g":"1ebb39946d4a0248","name":"","links":["08e07ab8bce4d1d4","00b9d66554df4dce"],"x":655,"y":560,"wires":[]},{"id":"2c4d79b34f1cfa44","type":"comment","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"Control dashboard","info":"","x":890,"y":560,"wires":[]},{"id":"6bd46ca443c5b1f4","type":"comment","z":"69b7af92a5a069e7","g":"1ebb39946d4a0248","name":"Charge phase: Fixes a setpoint for each charging phase.","info":"","x":270,"y":680,"wires":[]},{"id":"54e9dc534364fced","type":"link in","z":"69b7af92a5a069e7","g":"1ebb39946d4a0248","name":"","links":["57173daf7e57df64"],"x":75,"y":740,"wires":[["2d735d228482c173","11a95de179a81c82"]]},{"id":"2d735d228482c173","type":"debug","z":"69b7af92a5a069e7","g":"1ebb39946d4a0248","name":"","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":170,"y":780,"wires":[]},{"id":"ba2b6e7a8a89faad","type":"switch","z":"69b7af92a5a069e7","g":"1ebb39946d4a0248","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"3","vt":"num"},{"t":"eq","v":"4","vt":"num"},{"t":"eq","v":"5","vt":"num"},{"t":"else"}],"checkall":"false","repair":false,"outputs":4,"x":410,"y":740,"wires":[["fd15a80c9bac014a"],["40b4008d03db2b5b"],["e83125d57897d05b"],["67fbaa31380a19c8"]]},{"id":"fd15a80c9bac014a","type":"change","z":"69b7af92a5a069e7","g":"1ebb39946d4a0248","name":"2000","rules":[{"t":"set","p":"payload","pt":"msg","to":"2000","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":550,"y":700,"wires":[["785f6cfe025b6f42"]]},{"id":"40b4008d03db2b5b","type":"change","z":"69b7af92a5a069e7","g":"1ebb39946d4a0248","name":"500","rules":[{"t":"set","p":"payload","pt":"msg","to":"500","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":550,"y":740,"wires":[["785f6cfe025b6f42"]]},{"id":"e83125d57897d05b","type":"change","z":"69b7af92a5a069e7","g":"1ebb39946d4a0248","name":"50","rules":[{"t":"set","p":"payload","pt":"msg","to":"50","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":550,"y":780,"wires":[["785f6cfe025b6f42"]]},{"id":"67fbaa31380a19c8","type":"change","z":"69b7af92a5a069e7","g":"1ebb39946d4a0248","name":"6000 (warning)","rules":[{"t":"set","p":"payload","pt":"msg","to":"6000","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":580,"y":820,"wires":[["785f6cfe025b6f42"]]},{"id":"3c31bff57312dc9c","type":"link in","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","links":["785f6cfe025b6f42"],"x":1015,"y":900,"wires":[["684dc605d7dfb708"]]},{"id":"785f6cfe025b6f42","type":"link out","z":"69b7af92a5a069e7","g":"1ebb39946d4a0248","name":"","links":["3c31bff57312dc9c"],"x":715,"y":800,"wires":[]},{"id":"11a95de179a81c82","type":"switch","z":"69b7af92a5a069e7","g":"1ebb39946d4a0248","name":"if auto","property":"mode","propertyType":"flow","rules":[{"t":"gt","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":170,"y":740,"wires":[["be6d293e1e155cb3"]]},{"id":"be6d293e1e155cb3","type":"rbe","z":"69b7af92a5a069e7","g":"1ebb39946d4a0248","name":"","func":"rbe","gap":"","start":"","inout":"out","septopics":false,"property":"payload","topi":"topic","x":290,"y":740,"wires":[["ba2b6e7a8a89faad"]]},{"id":"3c01972bbf2db5c7","type":"link in","z":"69b7af92a5a069e7","d":true,"g":"1ebb39946d4a0248","name":"","links":["76cf8f4b3cf821e5"],"x":75,"y":980,"wires":[["d81def18fcf2bf5c","8f667782db66fa88"]]},{"id":"78acef3bcd0e7b23","type":"comment","z":"69b7af92a5a069e7","d":true,"g":"1ebb39946d4a0248","name":"SoC: Divert based on the SoC","info":"","x":180,"y":920,"wires":[]},{"id":"d81def18fcf2bf5c","type":"rbe","z":"69b7af92a5a069e7","d":true,"g":"1ebb39946d4a0248","name":"","func":"rbe","gap":"","start":"","inout":"out","septopics":true,"property":"payload","topi":"topic","x":230,"y":980,"wires":[["4837586ca7ffef26"]]},{"id":"8f667782db66fa88","type":"debug","z":"69b7af92a5a069e7","d":true,"g":"1ebb39946d4a0248","name":"","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":190,"y":1020,"wires":[]},{"id":"4837586ca7ffef26","type":"switch","z":"69b7af92a5a069e7","d":true,"g":"1ebb39946d4a0248","name":"","property":"payload","propertyType":"msg","rules":[{"t":"gte","v":"80","vt":"num"},{"t":"else"}],"checkall":"false","repair":false,"outputs":2,"x":350,"y":980,"wires":[["b333e19864118858"],["99a6ea2d44904081"]]},{"id":"b333e19864118858","type":"change","z":"69b7af92a5a069e7","d":true,"g":"1ebb39946d4a0248","name":"1","rules":[{"t":"set","p":"payload","pt":"msg","to":"1","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":490,"y":960,"wires":[["ca3ae8ae746f4a99"]]},{"id":"99a6ea2d44904081","type":"change","z":"69b7af92a5a069e7","d":true,"g":"1ebb39946d4a0248","name":"OFF","rules":[{"t":"set","p":"payload","pt":"msg","to":"0","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":490,"y":1000,"wires":[["ca3ae8ae746f4a99"]]},{"id":"3eafd083bf01380c","type":"link in","z":"69b7af92a5a069e7","g":"9f2cc92f0cfdb0ad","name":"","links":["ca3ae8ae746f4a99"],"x":1175,"y":680,"wires":[["7a169ab189f9bca6"]]},{"id":"ca3ae8ae746f4a99","type":"link out","z":"69b7af92a5a069e7","d":true,"g":"1ebb39946d4a0248","name":"","links":["3eafd083bf01380c"],"x":595,"y":980,"wires":[]},{"id":"89f3a67e239a2278","type":"switch","z":"69b7af92a5a069e7","g":"1ebb39946d4a0248","name":"if auto","property":"mode","propertyType":"flow","rules":[{"t":"gt","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":170,"y":560,"wires":[["7eac57b524a03f37"]]},{"id":"a603015cab524e4f","type":"change","z":"69b7af92a5a069e7","g":"894b547d465dbcea","name":"Manual","rules":[{"t":"set","p":"payload","pt":"msg","to":"0","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":900,"y":240,"wires":[["d557fae7edb437b2"]]},{"id":"3679467fdf3ef7b5","type":"switch","z":"69b7af92a5a069e7","g":"894b547d465dbcea","name":"if on","property":"mode","propertyType":"flow","rules":[{"t":"neq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":650,"y":140,"wires":[["019d61289868399d"]]},{"id":"c45a83a3.d00908","type":"ui_group","name":"Heater 1","tab":"80cd4062.93a5","order":1,"disp":true,"width":"12","collapse":false},{"id":"bf885360.b5a32","type":"mqtt-broker","name":"local","broker":"localhost","port":"1883","clientid":"","usetls":false,"compatmode":false,"protocolVersion":"4","keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willPayload":"","willMsg":{},"sessionExpiry":""},{"id":"80cd4062.93a5","type":"ui_tab","name":"Diverter","icon":"flash_on","disabled":false,"hidden":false}]
```

## TODOs:
- Making it a node-red node. :)

## Contribution

If that bit of work become useful to you, remember that you can make a donation or drop me a beer:
[![Donate](https://img.shields.io/badge/Donate-PayPal-green.svg)](https://www.paypal.com/donate?business=JRX9JK6SSY25N&no_recurring=0&item_name=Open+source+donations&currency_code=EUR)